{% extends "base.html" %}

{% block title %}Tableau de bord - Data Collection{% endblock %}

{% block content %}
<div class="container-fluid ">
    <!-- Statistiques -->
    <div class="row mb-1 g-3">
        <div class="col-md-3">
            <div class="card bg-light shadow-sm text-center p-3 h-100">
                <i class="fas fa-folder fa-2x text-primary mb-2"></i>
                <div class="h3 mb-1 stat-counter" data-target="{{ projects|length }}">0</div>
                <div class="text-muted">Projets actifs</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card  bg-light shadow-sm text-center p-3 h-100">
                <i class="fas fa-file-alt fa-2x text-success mb-2"></i>
                {% set total_forms = namespace(count=0) %}
                {% for project in projects %}
                    {% set total_forms.count = total_forms.count + project.forms|length %}
                {% endfor %}
                <div class="h3 mb-1 stat-counter" data-target="{{ total_forms.count }}">0</div>
                <div class="text-muted">Formulaires créés</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light shadow-sm text-center p-3 h-100">
                <i class="fas fa-database fa-2x text-info mb-2"></i>
                {% set total_submissions = namespace(count=0) %}
                {% for project in projects %}
                    {% for form in project.forms %}
                        {% set total_submissions.count = total_submissions.count + form.submissions|length %}
                    {% endfor %}
                {% endfor %}
                <div class="h3 mb-1 stat-counter" data-target="{{ total_submissions.count }}">0</div>
                <div class="text-muted">Soumissions reçues</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light shadow-sm text-center p-3 h-100">
                <i class="fas fa-share-alt fa-2x text-warning mb-2"></i>
                {% set shared_forms = namespace(count=0) %}
                {% for project in projects %}
                    {% for form in project.forms %}
                        {% if form.is_shared %}
                            {% set shared_forms.count = shared_forms.count + 1 %}
                        {% endif %}
                    {% endfor %}
                {% endfor %}
                <div class="h3 mb-1 stat-counter" data-target="{{ shared_forms.count }}">0</div>
                <div class="text-muted">Formulaires partagés</div>
            </div>
        </div>
    </div>

    <!-- Projets récents -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center bg-light">
                    <h5 class="mb-0">Projets récents</h5>
                    <a href="{{ url_for('projects.create_project') }}" class="btn btn-primary btn-sm">
                        <i class="fas fa-plus me-1"></i>Nouveau projet
                    </a>
                </div>
                <div class="card-body bg-light">
                    {% if projects %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover align-middle" id="projects-table">
                                <thead class="table-light">
                                    <tr>
                                        <th>Nom</th>
                                        <th>Description</th>
                                        <th>Formulaires</th>
                                        <th>Date de fin</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for project in projects[:5] %}
                                    <tr>
                                        <td><strong>{{ project.name }}</strong></td>
                                        <td>{{ project.description[:50] }}{% if project.description|length > 50 %}...{% endif %}</td>
                                        <td><span class="badge bg-secondary">{{ project.forms|length }}</span></td>
                                        <td>{{ project.end_date.strftime('%d/%m/%Y') }}</td>
                                        <td>
                                            <a href="{{ url_for('project_detail', project_id=project.id) }}" class="btn btn-sm btn-outline-primary">
                                                Voir
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info text-center py-4">
                            <i class="fas fa-folder-open fa-3x mb-3"></i>
                            <h5>Aucun projet créé</h5>
                            <p>Commencez par créer votre premier projet</p>
                            <a href="{{ url_for('projects.create_project') }}" class="btn btn-primary">
                                <i class="fas fa-plus me-1"></i>Créer un projet
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Animation compteur pour statistiques
    document.addEventListener("DOMContentLoaded", () => {
        const counters = document.querySelectorAll('.stat-counter');
        counters.forEach(counter => {
            const updateCount = () => {
                const target = +counter.getAttribute('data-target');
                const count = +counter.innerText;
                const increment = Math.ceil(target / 100);

                if (count < target) {
                    counter.innerText = count + increment;
                    setTimeout(updateCount, 20);
                } else {
                    counter.innerText = target;
                }
            };
            updateCount();
        });
    });

    // Optionnel : filtrage simple tableau
    document.addEventListener("DOMContentLoaded", () => {
        const table = document.getElementById("projects-table");
        // Ici tu peux ajouter recherche ou tri via JS si besoin
    });
</script>
{% endblock %}
